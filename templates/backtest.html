
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Backtesting System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .strategy-config-section {
            display: none;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #e3f2fd 100%);
        }

        .strategy-config-section.active {
            display: block;
        }

        .config-group {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #28a745;
        }

        .results-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .trade-result {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #17a2b8;
        }

        .trade-result.profitable {
            border-left-color: #28a745;
        }

        .trade-result.loss {
            border-left-color: #dc3545;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            margin: 5px 0;
        }

        .metric-value.positive {
            color: #28a745;
        }

        .metric-value.negative {
            color: #dc3545;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-chart-line"></i> Strategy Backtesting System
            </span>
            <a href="/" class="btn btn-outline-light btn-sm">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4><i class="fas fa-cogs"></i> Backtest Configuration</h4>
                        <p class="mb-0">Test your trading strategies with historical data and real logic</p>
                    </div>
                    <div class="card-body">
                        <form id="backtestForm">
                            <!-- Strategy Selection -->
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="strategySelect" class="form-label">
                                            <strong>Strategy Type</strong>
                                        </label>
                                        <select class="form-control" id="strategySelect" name="strategy_name" required>
                                            <option value="">Select Strategy to Test</option>
                                            <option value="rsi_oversold">RSI Oversold Strategy</option>
                                            <option value="macd_divergence">MACD Divergence Strategy</option>
                                            <option value="engulfing_pattern">Engulfing Pattern Strategy</option>
                                            <option value="smart_money">Smart Money Strategy</option>
                                        </select>
                                        <div class="form-text">Choose the strategy you want to backtest</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="startDate" class="form-label">
                                            <strong>Start Date</strong>
                                        </label>
                                        <input type="date" class="form-control" id="startDate" name="start_date" required>
                                        <div class="form-text">Beginning of test period</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="endDate" class="form-label">
                                            <strong>End Date</strong>
                                        </label>
                                        <input type="date" class="form-control" id="endDate" name="end_date" required>
                                        <div class="form-text">End of test period</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Basic Configuration -->
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="symbol" class="form-label">
                                            <strong>Trading Symbol</strong>
                                        </label>
                                        <select class="form-control" id="symbol" name="symbol" required>
                                            <option value="">Select Symbol</option>
                                            <option value="BTCUSDT">BTCUSDT</option>
                                            <option value="ETHUSDT">ETHUSDT</option>
                                            <option value="SOLUSDT">SOLUSDT</option>
                                            <option value="XRPUSDT">XRPUSDT</option>
                                            <option value="BCHUSDT">BCHUSDT</option>
                                        </select>
                                        <div class="form-text">Choose the trading pair to test</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="timeframe" class="form-label">
                                            <strong>Timeframe</strong>
                                        </label>
                                        <select class="form-control" id="timeframe" name="timeframe" required>
                                            <option value="">Select Timeframe</option>
                                            <option value="5m">5 minutes</option>
                                            <option value="15m">15 minutes</option>
                                            <option value="30m">30 minutes</option>
                                            <option value="1h">1 hour</option>
                                            <option value="4h">4 hours</option>
                                        </select>
                                        <div class="form-text">Chart timeframe for analysis</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="margin" class="form-label">
                                            <strong>Margin (USDT)</strong>
                                        </label>
                                        <input type="number" class="form-control" id="margin" name="margin" value="50" step="0.1" min="1" max="10000">
                                        <div class="form-text">Trading margin in USDT</div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="leverage" class="form-label">
                                            <strong>Leverage</strong>
                                        </label>
                                        <input type="number" class="form-control" id="leverage" name="leverage" value="5" min="1" max="125">
                                        <div class="form-text">Trading leverage multiplier</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Risk Management -->
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="max_loss_pct" class="form-label">
                                            <strong>Max Loss %</strong>
                                        </label>
                                        <input type="number" class="form-control" id="max_loss_pct" name="max_loss_pct" value="10" step="0.1" min="1" max="100">
                                        <div class="form-text">Maximum loss percentage of margin</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="assessment_interval" class="form-label">
                                            <strong>Assessment Interval (s)</strong>
                                        </label>
                                        <input type="number" class="form-control" id="assessment_interval" name="assessment_interval" value="60" min="5" max="3600">
                                        <div class="form-text">Market assessment frequency</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="cooldown_period" class="form-label">
                                            <strong>Cooldown Period (s)</strong>
                                        </label>
                                        <input type="number" class="form-control" id="cooldown_period" name="cooldown_period" value="300" min="30" max="7200">
                                        <div class="form-text">Time between trades</div>
                                    </div>
                                </div>
                            </div>

                            <!-- RSI Strategy Configuration -->
                            <div id="rsi_oversold_config" class="strategy-config-section">
                                <h5><i class="fas fa-chart-line"></i> RSI Strategy Parameters</h5>

                                <div class="config-group">
                                    <h6>RSI Entry/Exit Levels</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="rsi_long_entry" class="form-label">Long Entry RSI</label>
                                            <input type="number" class="form-control" id="rsi_long_entry" name="rsi_long_entry" value="30" min="10" max="50">
                                            <div class="form-text">Buy when RSI drops to this level</div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="rsi_long_exit" class="form-label">Long Exit RSI</label>
                                            <input type="number" class="form-control" id="rsi_long_exit" name="rsi_long_exit" value="70" min="50" max="90">
                                            <div class="form-text">Sell when RSI rises to this level</div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="rsi_short_entry" class="form-label">Short Entry RSI</label>
                                            <input type="number" class="form-control" id="rsi_short_entry" name="rsi_short_entry" value="70" min="50" max="90">
                                            <div class="form-text">Short when RSI rises to this level</div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="rsi_short_exit" class="form-label">Short Exit RSI</label>
                                            <input type="number" class="form-control" id="rsi_short_exit" name="rsi_short_exit" value="30" min="10" max="50">
                                            <div class="form-text">Cover when RSI drops to this level</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- MACD Strategy Configuration -->
                            <div id="macd_divergence_config" class="strategy-config-section">
                                <h5><i class="fas fa-wave-square"></i> MACD Strategy Parameters</h5>

                                <div class="config-group">
                                    <h6>MACD Indicator Settings</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="macd_fast" class="form-label">Fast EMA</label>
                                            <input type="number" class="form-control" id="macd_fast" name="macd_fast" value="12" min="2" max="30">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="macd_slow" class="form-label">Slow EMA</label>
                                            <input type="number" class="form-control" id="macd_slow" name="macd_slow" value="26" min="12" max="50">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="macd_signal" class="form-label">Signal EMA</label>
                                            <input type="number" class="form-control" id="macd_signal" name="macd_signal" value="9" min="2" max="20">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="min_histogram_threshold" class="form-label">Histogram Threshold</label>
                                            <input type="number" class="form-control" id="min_histogram_threshold" name="min_histogram_threshold" value="0.0001" step="0.00001">
                                        </div>
                                    </div>
                                </div>

                                <div class="config-group">
                                    <h6>Entry/Exit Thresholds</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="macd_entry_threshold" class="form-label">Entry Threshold</label>
                                            <input type="number" class="form-control" id="macd_entry_threshold" name="macd_entry_threshold" value="0.0015" step="0.0001">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="macd_exit_threshold" class="form-label">Exit Threshold</label>
                                            <input type="number" class="form-control" id="macd_exit_threshold" name="macd_exit_threshold" value="0.002" step="0.0001">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Engulfing Pattern Strategy Configuration -->
                            <div id="engulfing_pattern_config" class="strategy-config-section">
                                <h5><i class="fas fa-chart-bar"></i> Engulfing Pattern Strategy Parameters</h5>

                                <div class="config-group">
                                    <h6>Pattern Recognition Settings</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="rsi_threshold" class="form-label">RSI Threshold</label>
                                            <input type="number" class="form-control" id="rsi_threshold" name="rsi_threshold" value="50" min="30" max="70">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="stable_candle_ratio" class="form-label">Stable Candle Ratio</label>
                                            <input type="number" class="form-control" id="stable_candle_ratio" name="stable_candle_ratio" value="0.5" step="0.1" min="0.1" max="1.0">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="price_lookback_bars" class="form-label">Price Lookback Bars</label>
                                            <input type="number" class="form-control" id="price_lookback_bars" name="price_lookback_bars" value="5" min="3" max="20">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Smart Money Strategy Configuration -->
                            <div id="smart_money_config" class="strategy-config-section">
                                <h5><i class="fas fa-brain"></i> Smart Money Strategy Parameters</h5>

                                <div class="config-group">
                                    <h6>Smart Money Detection Settings</h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label for="swing_lookback_period" class="form-label">Swing Lookback Period</label>
                                            <input type="number" class="form-control" id="swing_lookback_period" name="swing_lookback_period" value="25" min="10" max="50">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="sweep_threshold_pct" class="form-label">Sweep Threshold %</label>
                                            <input type="number" class="form-control" id="sweep_threshold_pct" name="sweep_threshold_pct" value="0.1" step="0.01">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="volume_spike_multiplier" class="form-label">Volume Spike Multiplier</label>
                                            <input type="number" class="form-control" id="volume_spike_multiplier" name="volume_spike_multiplier" value="2.0" step="0.1">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-play"></i> Run Backtest
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg ml-3" onclick="resetForm()">
                                    <i class="fas fa-redo"></i> Reset Configuration
                                </button>
                            </div>
                        </form>

                        <!-- Loading Spinner -->
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Running backtest... This may take a few minutes.</p>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="results-section">
                    <h4><i class="fas fa-chart-area"></i> Backtest Results</h4>

                    <!-- Performance Metrics -->
                    <div id="performanceMetrics" class="performance-metrics">
                        <!-- Metrics will be populated here -->
                    </div>

                    <!-- Trade Details -->
                    <div class="mt-4">
                        <h5><i class="fas fa-list"></i> Individual Trades</h5>
                        <div id="tradeDetails">
                            <!-- Trade details will be populated here -->
                        </div>
                    </div>

                    <!-- Export Options -->
                    <div class="text-center mt-4">
                        <button class="btn btn-success" onclick="exportResults()">
                            <i class="fas fa-download"></i> Export Results to JSON
                        </button>
                        <button class="btn btn-info ml-2" onclick="generateReport()">
                            <i class="fas fa-file-pdf"></i> Generate PDF Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentResults = null;

        // Strategy selection handler
        document.getElementById('strategySelect').addEventListener('change', function() {
            // Hide all config sections
            document.querySelectorAll('.strategy-config-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected strategy config
            const selectedStrategy = this.value;
            if (selectedStrategy) {
                const configSection = document.getElementById(selectedStrategy + '_config');
                if (configSection) {
                    configSection.classList.add('active');
                }
            }
        });

        // Set default dates and values
        function setDefaultDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 1); // 1 month ago

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            // Set default symbol and timeframe
            document.getElementById('symbol').value = 'BTCUSDT';
            document.getElementById('timeframe').value = '15m';
        }

        // Form submission
        document.getElementById('backtestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            runBacktest();
        });

        async function runBacktest() {
            const strategy = document.getElementById('strategySelect').value;

            if (!strategy) {
                alert('Please select a strategy to test');
                return;
            }

            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';

            // Collect form data
            const formData = new FormData(document.getElementById('backtestForm'));
            const params = {};
            
            for (let [key, value] of formData.entries()) {
                if (value !== null && value.toString().trim() !== '') {
                    params[key] = value.toString().trim();
                }
            }

            // Ensure required fields are set
            if (!params.symbol) {
                alert('Please select a trading symbol');
                document.getElementById('loadingSpinner').style.display = 'none';
                return;
            }

            if (!params.timeframe) {
                alert('Please select a timeframe');
                document.getElementById('loadingSpinner').style.display = 'none';
                return;
            }

            console.log('ðŸš€ Submitting backtest with params:', params);

            try {
                const response = await fetch('/api/backtest/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(params)
                });

                const result = await response.json();
                console.log('ðŸ“Š Backtest result:', result);

                if (result.success) {
                    currentResults = result.result;
                    displayResults(result.result);
                } else {
                    alert('Backtest failed: ' + result.error);
                }
            } catch (error) {
                console.error('Error running backtest:', error);
                alert('Error running backtest: ' + error.message);
            } finally {
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        }

        function displayResults(results) {
            if (results.error) {
                alert('Backtest error: ' + results.error);
                return;
            }

            // Show results section
            document.getElementById('resultsSection').style.display = 'block';

            // Display performance metrics
            displayPerformanceMetrics(results.performance);

            // Display trade details
            displayTradeDetails(results.trades);

            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function displayPerformanceMetrics(performance) {
            const metricsContainer = document.getElementById('performanceMetrics');

            const metrics = [
                { label: 'Total Trades', value: performance.total_trades, type: 'neutral' },
                { label: 'Win Rate', value: performance.win_rate.toFixed(1) + '%', type: performance.win_rate >= 50 ? 'positive' : 'negative' },
                { label: 'Total PnL', value: '$' + performance.total_pnl_usdt.toFixed(2), type: performance.total_pnl_usdt >= 0 ? 'positive' : 'negative' },
                { label: 'Avg PnL/Trade', value: '$' + performance.avg_pnl_per_trade_usdt.toFixed(2), type: performance.avg_pnl_per_trade_usdt >= 0 ? 'positive' : 'negative' },
                { label: 'Max Win', value: '$' + performance.max_win_usdt.toFixed(2), type: 'positive' },
                { label: 'Max Loss', value: '$' + performance.max_loss_usdt.toFixed(2), type: 'negative' },
                { label: 'Max Drawdown', value: '$' + performance.max_drawdown_usdt.toFixed(2), type: 'negative' },
                { label: 'Sharpe Ratio', value: performance.sharpe_ratio.toFixed(2), type: performance.sharpe_ratio >= 1 ? 'positive' : 'neutral' },
                { label: 'Profit Factor', value: performance.profit_factor.toFixed(2), type: performance.profit_factor >= 1 ? 'positive' : 'negative' }
            ];

            metricsContainer.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-value ${metric.type}">${metric.value}</div>
                </div>
            `).join('');
        }

        function displayTradeDetails(trades) {
            const tradesContainer = document.getElementById('tradeDetails');

            if (!trades || trades.length === 0) {
                tradesContainer.innerHTML = '<p class="text-muted">No trades executed during the backtest period.</p>';
                return;
            }

            tradesContainer.innerHTML = trades.map((trade, index) => {
                const pnlClass = trade.pnl_usdt >= 0 ? 'profitable' : 'loss';
                const pnlIcon = trade.pnl_usdt >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

                return `
                    <div class="trade-result ${pnlClass}">
                        <div class="row">
                            <div class="col-md-2">
                                <strong>Trade #${index + 1}</strong><br>
                                <small class="text-muted">${trade.side}</small>
                            </div>
                            <div class="col-md-2">
                                <strong>Entry</strong><br>
                                $${trade.entry_price.toFixed(4)}<br>
                                <small>${new Date(trade.entry_time).toLocaleString()}</small>
                            </div>
                            <div class="col-md-2">
                                <strong>Exit</strong><br>
                                $${trade.exit_price.toFixed(4)}<br>
                                <small>${new Date(trade.exit_time).toLocaleString()}</small>
                            </div>
                            <div class="col-md-2">
                                <strong>PnL</strong><br>
                                <i class="fas ${pnlIcon}"></i> $${trade.pnl_usdt.toFixed(2)}<br>
                                <small>(${trade.pnl_percentage.toFixed(1)}%)</small>
                            </div>
                            <div class="col-md-2">
                                <strong>Duration</strong><br>
                                ${Math.round(trade.duration_minutes)} min<br>
                                <small>Margin: $${trade.margin_used}</small>
                            </div>
                            <div class="col-md-2">
                                <strong>Reasons</strong><br>
                                <small><strong>Entry:</strong> ${trade.entry_reason}</small><br>
                                <small><strong>Exit:</strong> ${trade.exit_reason}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function resetForm() {
            document.getElementById('backtestForm').reset();
            document.querySelectorAll('.strategy-config-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('resultsSection').style.display = 'none';
            setDefaultDates();
        }

        function exportResults() {
            if (!currentResults) {
                alert('No results to export');
                return;
            }

            const dataStr = JSON.stringify(currentResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `backtest_results_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function generateReport() {
            if (!currentResults) {
                alert('No results to generate report from');
                return;
            }

            alert('PDF report generation feature coming soon!');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultDates();
        });
    </script>
</body>
</html>
